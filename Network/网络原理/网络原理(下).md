# 网络原理(下)

## 网络层

### 网络层功能

- 转发

- 路由选择：当分组从发送方流向接收方时，网络层必须决定这些分组所采用的路由或路径。计算这些路径的算法被称为选路算法，一个选路算法将决定分组从源主机到目的主机所遵循的路径。

    每台路由器具有一张转发表，就像立交桥上的指示牌。路由器通过检查到达分组首部中的一个目的地地址字段，然后使用该值在转发表中查询来转发一个分组。根据查询结果 将分组将被转发的路由器的链路接口。

- 连接建立：在计算机网络发展过程中，曾经有些网络层体系结构(如 ATM、帧中继)，要求从源到目的地沿着所选择的路径彼此协作，以便在网络层数据分组能够开始流动之前，给定的源到目的地连接之间建立起连接状态。在网络层，这个过程被称为连接建立。但是因特网不需要这样的连接建立过程。

### IP 报文

![](img/IP1.jpg)

- 版本：IP报文的版本号，为一个四位字段，常用的版本为 IPV4 和 IPV6
- 报头长度：IP报头的长度
- 服务类型：指定特殊的报文处理方式
- 标识符：IP报文分片时作为相同报文的标识符，为１６位二进制数，同标记字段和分片偏移字段一起使用；
- 标记字段：作为IP报文的分片标志，由三位二进制数表示，其中，第一位没有使用；第二位为不分片位（DF），当其为1时，表示IP报文不能进行分片，如果报文因为不能分片而不能完成转发，那们路由器会丢弃该报文，并向源点发送错误信息，我们可以通过这种方法来去计算网络中的MTU（Maximum Transmission Unit　网络中最大传输单元）；第三位位后继分片（MF），当路由器对IP报文进行分片时，最后一个分片将该位设置为0，表示没有后继分片，其余个分片均设置为1；
- 分片偏移：表示分片起始点相对于报头起始点的偏移量
- 生存时间（TTL）
- 协议：指定报文中信息的类型，长度为8位，给出了主机到主机层或传输层协议的”地址“或协议号；字段值指明了 IP 数据报的数据部分应交给哪个传输层协议。例如，值为 6 表明数据部分要交给 TCP，而值为 17 表明数据要交给 UDP。 注意，数据报中的协议号所起的作用类似于传输层报文段中端口号字段所起的作用。
- 报头校验和
- 源地址和目的地址

### 数据分片

井不是所有的链路层协议都能承载相同长度的网络层分组。有的协议能承载大分组，而有的协议只能承载小分组。例如，以太网帧可承载不超过 1500 字节的数据，而某些广域网链路的帧可承载不超过 576 字节的数据。

一个链路层帧能承载的最大数据量叫做最大传输单元 MTU。

假设有一个互连几条链路的路由器，且每条链路运行具有不同 MTU 的链路层协议。假定你从某条链路收到一个 IP 数据报，通过检查转发表决定出链路，但该出链路的 MTU 比该 IP数据报的长度小。

如何将这个过大的 IP 数据报封装成链路层帧呢?

解决该问题的方法是将 IP 数据报中的数据分片成两个或更多个较小的数据报，用单独的链路层帧封装这些较小的 IP 数据报，然后向输出链路上发送这些帧。这些较小的数据报叫做分片。

在其到达目的地传输层以前需要被重新组装。数据报的重新组装工作在端系统中，而不是在途径的路由器中。

因此，一个具有长度较大的数据报流经具有较小 MTU 的链路时需要分片，分片的重组中在目的端系统中进行。

例子，一个 4000 字节的数据报(20 字节 IP 首部加上 3980 字节 IP 有效载荷)到达一台路由器，被转发到一条 MTU 为 1500 字节的链路上。这就意味着初始数据报中的 3980 字节数据必须被分成 3 个独立的片(每个片也是一个 IP 数据报)。假定初始数据报附加上的标识号为 777。三个片的特点如表所示。

除了最后一片外所有初始有效载荷数据的数量应当是 8 字节的倍数，并且偏移值应当被规定以 8 字节块为单位(片偏移的表示范围比数据报长度字段小了 8 倍，所以以 8 字节为单位)。

![](img/IP2.jpg)

### IP 编址

#### IP 地址类型

IP地址类型分为A、B、C、D、E

A、B、C类：我们生活中常用的类型的 IP 地址

D类：组播地址在路由协议的时候会讲到几个常用的几个，用户组播地址在CCIE中学习。

E类：仅供Internet实验和开发

> 注：A类前一位为0，B类前两位为10（其他位任意）；C类前三位为110（其他位任意）；D类前四位为1110（其他位任意）；E类前五位为11110（其他位任意），其中127和0开头的为特殊地址；

![](img/IP3.png)

![](img/IP4.png)

#### 公网地址和私网地址

![](img/IP5.png)

#### 有类和无类 IP 地址

有类（主类）IP地址：主要分为A、B、C类，每种类型固定的掩码。

无类IP地址：无论哪种类型的IP地址都没有固定掩码。

![](img/IP6.png)

#### 什么是掩码（子网掩码）？

子网掩码不能单独存在，它必须结合IP地址一起使用。子网掩码只有一个作用，就是将某个IP地址划分成网络地址和主机地址两部分。

简单点说就像隔房间的墙，把大房间分割成一个个小房间。

#### 掩码的表示方式

![](img/IP8.png)

#### 无类的IP地址规划

![](img/IP7.jpg)

#### 无类地址进行划分 VLSM

例子:B类地址子网变长

B类地址从原来的/16变为/24，掩码进行变长，这时候使用的是VLSM（可变长的子网掩码）；

掩码边长使网段的主机数减少，但增加了子网数量；

举个例子，在现实生活中买100平米的房子，大多数人都会将房子分割成一个个功能区房间，餐厅，厨房等，虽然每个房间面积变小但是功能区分割清楚。这个跟我们IP地址进行VLSM意思一样，在/16的时候地址空间是很大，但是没法进行细分各个网段的功能

比如172.16.0.0/16变长为/24这时候，地址范围、网络地址、广播地址产生变化，可以将容纳更多的网段，但减少每个网段承载的主机数量。

![](img/IP9.PNG)

#### 子网掩码变长路由汇总 CIDR

子网掩码变长以后使路由更容易进行汇总，比如右侧有多个192.168.1.x的网段，这时候只需要发布一条192.168.1.0/24路由就可以进行汇总，而且大大降低了地址的浪费，在后面讲到路由和现网地址规划内容就可知道汇总的重要性。

![](img/IP10.PNG)

#### CIDR的使用

在现实网络中路由条目数决定了设备的运行效率，就跟电脑开应用程序一样，太多的运用程序占用大量的内容，使机器变慢。路由也是一样会占用设备的内存，路由条目数越多设备运行越慢。所以有效的路由汇总可以大大的减少设备的运行压力。

比如以下右侧的有3条C类路由，这时候在通告个周围的邻居的时候，正常情况下要3条路由。这时候如果使用CIDR将3条路由汇总为1条路由发布，可以减少设备的压力。

![](img/IP11.PNG)

#### CIDR 与连续性

四个IP号段如下：
1111 1111.1110 0111/16
1111 1111.1110 0011/16
1111 1111.1110 0001/16
1111 1111.1110 0110/16

这四个IP号段有共同特征：从左到右数一数有 13 位是相同：

255.224.0.0/13

这个归纳后的IP号段还把另外一些IP号段囊括其中，其中还有12个：

1111 1111.1110 0000/16
1111 1111.1110 0010/16
1111 1111.1110 0100/16
…
1111 1111.1110 0101/16

有同学会说，囊括它们又如何？不是按照最长匹配原则吗？如果别人的路由表有以下两条路由，肯定选择前者，因为它16位，后者13位。1111 1111.1110 0100/161111 1111.1110 0/13看似很有道理，但万一路由1111 1111.1110 0100/16由于接口down，从全球路由表消失了，但我们的归纳路由1111 1111.1110 0/13不会消失，所以发往1111 1111.1110 0100/16的流量全部被归纳路由吸引了过来，流量吸引过来还不算最坏的状况，甚至能造成路由的环路，因为流量过来了，全球的路由表不能及时同步，会将流量继续发给1111 1111.1110 0100/16，而有一些及时得到同步的路由器会使用1111 1111.1110 0/13，将流量发送回来，于是一个环路就形成了。

因此：归纳路由要保证子路由是连续的

依据此原则，以上四条路由只有
1111 1111.1110 0111/16
1111 1111.1110 0110/16

是可以归纳的，归纳为
1111 1111.1110 011/15

#### 主机数计算

在一个网段中能够支持多少个主机使用呢？下面我们来计算下主机数。在主机数的计算中我们要注意减去2个地址，这两个地址分别是网络地址和广播地址。

主机数为：2^n

可用主机数为 : 2^n-2

> 例如192.168.1.0/24能够支持多少个主机？
>
2^8-2=254
>
所以能支持254个IP地址
>
例如192.168.0.0/22能够支持多少个主机？
>
2^10-2=1022
>
所以能支持1022个IP地址

![](img/IP12.PNG)

#### 子网数计算

a能够支持最大的主机的子网掩码

b能够支持最小的主机的子网掩码

2^(b-a)=子网数

>
比如192.168.1.0/24能够分配多少个/27子网掩码的网段？
>
2^(27-24)=8
>
能够支持8个子网数。

#### 某公司分配到C类地址201.222.5.0。假设需要20个子网，每个子网有5台主机，我们该如何划分？

- 首先要5台主机
 
    > 2^n-2>5
    
    >所以n最小取值为3，掩码为29

-  能够支持多少个子网？ 
    > 首先C类地址那掩码为/24位，然后进行无类掩码/29位，计算2^(29-24)=32

    > 能够支持32个子网数。


### DHCP原理

- 第一步：DHCP服务器发现。广播地址255.255.255.255，源地址0.0.0.0
- 第二步：DHCP服务器提供。DHCP 服务器收到一个 DHCP 发现消息时，用一个 DHCP 提供消息对客户机做出响应， 仍然使用 IP 广播地址 255.255.255.255。子网中可能有多个 DHCP 服务器，所以该客户机可以选择其中的一个 DHCP 服务器。每个服务器提供消息中含有客户机请求的事务 ID、向客户机推荐的 IP 地址、网络掩码以及 IP 地址租用期、DNS服务器IP地址，默认网关IP地址、
- 第三步：DHCP请求：DHCP客户端选择它所接收到的第一个DHCPOFFER报文提供的IP地址。之后，它把这一信息广播至网络。该报文中，客户端请求服务器提供给它的IP地址。这是因为客户端可能收到不止一个DHCP服务器发送的offer。通过广播这一请求，客户端告知其他DHCP服务器不会再接受其他offer。
- 第四步：DHCP ACK：服务器用这个消息对 DHCP 请求消息进行响应，确认所要求的参数。 一旦客户机收到 DHCP ACK 后，交互便完成了，该客户机就能够在租用期内使用 DHCP 分配给它的IP 地址。

### 网络地址转换 NAT

NAT技术让少数公有IP地址被使用私有地址的大量主机所共享。这一机制允许远多于IP地址空间所支持的主机共享网络。同时，由于NAT屏蔽了内部网络，也为局域网内的机器提供了安全保障。

NAT的基本实施过程包括使用一个预留给本地IP网络的私有地址成立组织的内部网络，同时分配给组织一个或多个公网IP地址，并在本地网络与公网之间安装一个或多个具有NAT功能的路由器。

NAT路由器实现的功能包括将数据报中私网地址转换成公网地址，反向亦然。当有报文通过时，网络地址转换其不仅检查报文信息，还将报文头中的IP地址和端口信息进行修改，以使处于NAT之后的机器共享少数公网IP地址。

- 网络地址转换类型：

    静态NAT：此类NAT在本地和全局地址之间做一到一的永久映射。须注意静态NAT要求用户对每一台主机都有一个真实的Internet IP地址。静态转换是一对一的转换，有多少内网地址需要转换，就需要相应的公网地址；用得很少；

    动态NAT：动态转换是多对多的转换，通常需要转换的内网地址略多于相应的公网地址；将公网地址放在一个地址池里，当有内网地址需要访问外部网站时，从地址池中取出一个公网地址，用于内网地址到公网地址的转换；该方式适用于内网地址略多于给定的公网地址，如果内网地址远大于公网地址，当多台内网机器需要访问公网时，会出现地址池枯竭，无法获得对应的公网地址；

    端口NAT（PAT）：最为流行的NAT配置类型。通过多个源端口，将多个未登记的IP地址映射到一个合法IP地址（多到一）。使用PAT能够使上千个用户仅使用一个全局IP地址连接到Internet。
    
    ![](img/NAT.jpg)
    
### 互联网控制报文协议 IMCP

ICMP 用于主机和路由器彼此交互网络层信息。ICMP 最典型的用途是差错报告。

Internet操作是由路由器严密监控的。当路由器端处理报文时如有意外发生，事件通过ICMP报告给发送端。ICMP也用来测试Internet。ICMP信息封装在IP报文中

ICMP 通常被认为是 IP 的一部分，但从体系结构上讲它是位于 IP 之上，因为 ICMP 报文 是承载在 IP 分组中的。

ICMP 报文有一个类型字段和一个编码字段，并且包含引起该 ICMP 报文首次生成的 IP 数据报(以便发送方能确定引发该差错的数据报)的首部和前 8 字节内容。

- ICMP 主要报文

    ![](img/ICMP.jpg)


	DESTINATION UNREACHABLE消息用于当路由器无法找到目标地址或当设置了DF位的报文无法递送，因为路径上存在“小报文”网络。
	
	TIME EXCEEDED消息是由于报文TTL（Time to live）计数器到达0时。该事件是报文在回环，或计数器值设置过低的迹象。对于这一错误信息的聪明的应用是traceroute工具，traceroute发现从主机到目的IP地址路径上的路由器。它向目的地发送IP包，第一次的时候，将TTL设置为1，引发第一个路由器的Time Exceeded错误。这样，第一个路由器回复ICMP包，从而让出发主机知道途径的第一个路由器的信息。随后TTL被设置为2、3、4，...，直到到达目的主机。这样，沿途的每个路由器都会向出发主机发送ICMP包来汇报错误。traceroute将ICMP包的信息打印在屏幕上，就是接力路径的信息了。这并不是TIME EXCEEDED信息的本意，但却是非常有用的故障排查工具。
	
	PARAMETER PROBLEM信息表示报文头字段发现了非法值。这一问题表明发送主机的IP软件或可能是途经的路由器发生了bug。
	
	SOURCE QUENCH信息以前用来节制发送太多报文的主机。当主机接收到该信息，它预计将放缓发送报文。现在很少使用，因为当拥塞发生时，这类报文会起到火上浇油的作用，而且也不清楚如何做出回应。Internet中的拥塞控制现在大部分在传输层完成，使用报文丢失作为拥塞信号。
	
	REDIRECT信息用于路由器发现报文被错误路由的时候。路由器用该信息告知发送主机更新合适的路径。
	
	主机发送ECHO和ECHO REPLY信息以查看目前的目的地址是否可到达或是否alive。接收到ECHO信息之后，目的地址预计会发回一条ECHO REPLY信息。这些信息用在ping工具中来查看主机是否up以及是否挂在网上。
	
	TIMESTAMP REQUEST和TIME REPLY信息是类似的，除了信息的到达时间以及回复的离开时间是记录在回复中的。这一工具可用于衡量网络性能。
	
	ROUTER ADVERTISEMENT和ROUTER SOLICITATION信息用于主机发现附近的路由器。主机需要从至少一个路由器学习IP地址来发送报文。
	
### 路由选择算法

一台主机通常直接与一台路由器相连接，该路由器即为该主机的默认路由器，又称为该主机的默认网关。每当某主机向外部网络发送一个分组时，该分组都被传送给它的默认网关。

如果将源主机的默认网关称为源路由器,把目的主机的默认网关称为目的路由器。为一个分组从源主机到目的主机选路的问题于是可归结为从源路由器到目的路由器的选路问题。

全局选路算法：用完整的、全局性的网络信息来计算从源到目的之间的最低费用路径。具有全局状态信息的算法常被称作链路状态 LS 算法，因为该算法必须知道网络中每条链路的费用。

分布式选路算法：以迭代的、分布式的方式计算出最低费用路径。通过迭代计算并与相邻节点交换信息，逐渐计算出到达某目的节点或一组目的节点的最低费用路径。

DV 算法是分布式选路算法，因为每个节点维护到网络中的所有其他节点的费用(距离)估计的矢量。

- 链路状态选路算法 LS
    
    在链路状态算法中，通过让每个节点向所有其他路由器广播链路状态分组，每个链路状态分组包含它所连接的链路的特征和费用，从而网络中每个节点都建立了关于整个网络的拓扑。

    Dijkstra 算法计算从源节点到网络中所有其他节点的最低费用路径.
    
- 距离矢量选路算法 DV

-  LS 与 DV 选路算法的比较

    在 DV 算法中，每个节点仅与它的直接相连邻居交换信息，但它为它的邻居提供了从其 自己到网络中(它所知道的)所有其他节点的最低费用估计。

    在 LS 算法中，每个节点(经广播)与所有其他节点交换信息，但它仅告诉它们与它直接 相连链路的费用。
	
### 分层次的路由选择协议

#### 互联网采用分层次的路由选择协议

- 互联网的规模非常大。如果让所有的路由器知道所有的网络应怎样到达，则这种路由表将非常大，处理起来也太花时间。

- 许多单位不愿意外界了解自己单位网络的布局细节和本部门所采用的路由选择协议（这属于本部门内部的事情），但同时还希望连接到互联网上。
	
#### 自治系统 AS (Autonomous System)

在单一的技术管理下的一组路由器，而这些路由器使用一种 AS 内部的路由选择协议和共同的度量以确定分组在该 AS 内的路由，同时还使用一种 AS 之间的路由选择协议用以确定分组在 AS之间的路由。

尽管一个 AS 使用了多种内部路由选择协议和度量，但重要的是一个 AS 对其他 AS 表现出的是一个单一的和一致的路由选择策略。

![](img/AS.png)

#### 两大类路由选择协议

- 内部网关协议 IGP (Interior Gateway Protocol)

    - 在一个自治系统内部使用的路由选择协议
    - 具体的协议有多种，如接下来会介绍的RIP和OSPF

- 外部网关协议 EGP (External Gateway Protocol)

    - 用于将路由选择信息传递到另一个自治系统中
    - 目前使用的最多的是 BGP-4
	
### 因特网自治系统内部路由选择协议：RIP（DV 算法）

路由信息协议 RIP (Routing Information Protocol) 是内部网关协议 IGP 中最先得到广泛使用的协议。
RIP 是一种分布式的、基于距离向量的路由选择协议。

RIP 协议中的“距离”也称为“跳数”(hop count)，因为每经过一个路由器，跳数就加 1。（这里的“距离”实际上就是指“最短距离”）

#### RIP协议的特点

- 仅和相邻路由器交换信息

- 交换的信息是当前本路由器所知道的全部信息，即自己的路由表

- 按固定的时间间隔交换路由信息

- *“好消息传播得快，坏消息传播得慢”

#### 路由表的建立与更新

```
路由器收到相邻路由器（其地址为 X）的一个 RIP 报文：

(1) 先修改此 RIP 报文中的所有项目：把“下一跳”字段中的地址都改为 X，并把所有的“距离”字段的值加 1。

(2) 对修改后的 RIP 报文中的每一个项目，重复以下步骤：
若项目中的目的网络不在路由表中，则把该项目加到路由表中。
否则
若下一跳字段给出的路由器地址是同样的，则把收到的项目替换原路由表中的项目。
否则
若收到项目中的距离小于路由表中的距离，则进行更新，
否则，什么也不做。

(3) 若 3 分钟还没有收到相邻路由器的更新路由表，则把此相邻路由器记为不可达路由器，即将距离置为 16（表示不可达）。

(4) 返回。


```

文字叙述看着有点累，不过理解了“不同路径选短的，同样路径选新的”的思路就会很容易。

![](img/RIP.gif)

### 虚电路和数据报网络

虚电路的概念来源于电话领域，它采用了真正的电路，使用 VC 号转发分组。

因特网作为一种数据报网络，是由互连计算机的需求发展而来的，使用 IP 地址转发分组。

- 曾经的许多网络体系结构(包括 ATM、帧中继)都是虚电路网络，在网络层使用连接，这 些网络层连接被称为虚电路。

    在网络层的虚电路建立与传输层的连接建立之间的区别：
    
    - 传输层的连接建立仅涉及两个端系统。
    - 虚电路网络中，沿两个端系统之间路径土的路由器都要参与虚电路的建立，且每台路由 器都完全知道经过它的所有虚电路。
    
- 在数据报网络中，每当一个端系统要发送分组时，它就为该分组加上目的地端系统的地址，然后将该分组推进网络中。
    
    在数据报网络中，路由器没有虚电路的概念，当然不维护任何类似虚电路的状态信息。

    分组从源向目的地传输通过一系列路由器。路由器中的每个都使用该分组的目的地址来 转发该分组。

    路由器有一个将目的地址映射到链路接口的转发表，当分组到达路由器时，该路由器使用该分组的目的地址在该转发表中查找适当的输出链路接口。然后，路由器有意识地将该分 组向该输出链路接口转发。

